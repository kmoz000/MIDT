```mermaid
flowchart TD
    A[Start: Secure Medical Records System] --> B[1. Encrypt Medical Records]
    B --> C[Store Encrypted Records in IPFS]
    C --> D[Link IPFS CID to TRC-721 Token]
    D --> E[Role-Based Access via Badges]
    
    %% Badge System Subflow
    E --> F[Assign Badge to Wallet via Smart Contract]
    F --> G[Role: Verified Medical Institute (0x01)]
    F --> H[Role: Patient (0x02)]
    E --> I[Verify Role Before Access]

    %% One-Time Access Subflow
    D --> J[One-Time Access Mechanism]
    J --> K[Medical Institute Requests Access]
    K --> L[Token Holder Approves Access via Smart Contract]
    L --> M[Generate One-Time Decryption Key]
    M --> N[Custom Viewer Enforces Access Rules]

    %% Embedded Access Logs Subflow
    D --> O[Embed Access Logs in File Metadata]
    O --> P[Log View, Modify, and Transfer Actions]
    P --> Q[Sign Logs Cryptographically]
    Q --> R[Update File CID After Log Append]

    %% Privacy and Accountability
    J --> S[Control Decryption in Secure Environments]
    S --> T[Use Secure Viewing Platforms or Secure Enclaves]
    O --> U[Maintain Immutable Logs On-Chain or Off-Chain]

    %% Challenges and Solutions Subflow
    D --> X[Challenges and Solutions]
    X --> X1[Challenge 1: Badge Spoofing]
    X1 --> Y1[Solution: Verify Roles on-Chain]
    
    X --> X2[Challenge 2: Tamper-Proof Logging]
    X2 --> Y2[Solution: Cryptographic Signatures, Immutable Logs]
    
    X --> X3[Challenge 3: Scalability of Logs]
    X3 --> Y3[Solution: Off-Chain Logs with On-Chain Hash Commitments]

    %% End
    U --> Z[End: Secure, Accountable, and Flexible Medical Records System]
```
